#!/usr/bin/env node

if (!process.argv[2] || !process.argv[3] || !process.argv[4]) {
    console.log('usage: ./create-server-info HOST PORT SECURE');
    process.exit(code = 1);
    return;
}

var mongoose = require('mongoose'),
    async = require('async'),
    uuid = require('../lib/util/uuid'),
    Settings = require('settings'),
    sysConfig = new Settings(require('../config'));

mongoose.connect('mongodb://' + sysConfig.mongodb.host + ':' + sysConfig.mongodb.port + '/' + sysConfig.mongodb.database);

mongoose.model('ApiServer', require('../models/tracker/api-server').ApiServer);

async.waterfall([
    function (cb) {
        mongoose.model('ApiServer').create(
            {
                host: process.argv[2],
                port: process.argv[3],
                secure: process.argv[4],
                uuid: uuid.v4(),
                secret: require('secure-random').randomBuffer(48).toString('hex')
            }, cb
        );
    }
], function (err, server_info) {
    if (err) {
        console.log('error creating server info', err);
        process.exit(code = 1);
    } else {
        console.log('sucessfully created server info', server_info);
        process.exit(code = 0);
    }
});
